<?php

// Define default variables
define('VKXP_DEFAULT_BROWSER', 'Mozilla/5.0 (Windows; U; Windows NT 6.1; ru; rv:1.9.2.13) Gecko/20101203 Firefox/3.6.13)');

/**
 * Implementation of hook_menu()
 */
function vkxp_menu() {
  $items = array();
  $items['admin/settings/vkxp'] = array(
    'title' => 'VKontakte CrossPoster',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('vkxp_admin_main_settings'),
    'access arguments' => array('administer vkontakte crossposter'),
    'file' => 'vkxp.admin.inc',
  );
  $items['admin/settings/vkxp/main'] = array(
    'title' => 'Main settings',
    'file' => 'vkxp.admin.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/settings/vkxp/node'] = array(
    'title' => 'Node settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('vkxp_admin_node_settings'),
    'access arguments' => array('administer vkontakte crossposter'),
    'file' => 'vkxp.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implementation of hook_perm()
 */
function vkxp_perm() {
  return array('administer vkontakte crossposter');
}

/**
 * Implementation of hook_nodeapi
 */
function vkxp_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  switch ($op) {
    case 'insert':
    case 'update':
      if (variable_get('vkxp_enable', 0)) {

        // Get node types that should be crossposted
        $types = variable_get('vkxp_node_types', array());
        $selected_types = array();
        foreach ($types as $key => $type) {
          if ($type) {
            $selected_types[$key] = $type;
          }
        }

        // If current node related to selected types list - crosspost it!
        if (in_array($node->type, $selected_types)) {
          // Get aliased node url
          $url = url('node/'. $node->nid, array('absolute' => TRUE));

          // Get title and trim if needed
          $title = trim(strip_tags($node->title));
          if (variable_get('vkxp_cut_title', 1)) {
            $length = variable_get('vkxp_cut_title_length', 255);
            if (drupal_strlen($title) > $length) {
              $title = drupal_substr($title, 0, $length - 3) . '...';
            }
          }

          // Get body and trim if needed
          $body = trim(strip_tags($node->body));
          if (variable_get('vkxp_cut_body', 1)) {
            $length = variable_get('vkxp_cut_body_length', 255);
            if (drupal_strlen($body) > $length) {
              $body = drupal_substr($body, 0, $length - 3) . '...';
            }
          }

          $access_token = variable_get('vkxp_access_token', '');
          $group_id = variable_get('vkxp_group_id', '');

          // Get upload server
          $params = array();
          $params['gid'] = $group_id;
          $params['access_token'] = $access_token;
          $result = _vkxp_curl_post('photos.getWallUploadServer', $params);
          $result = json_decode($result, true);
          $upload_url = $result['response']['upload_url'];

          // Upload photo via cURL
          $ch = curl_init();
          curl_setopt ($ch, CURLOPT_URL, $upload_url);
          curl_setopt ($ch, CURLOPT_POST, 1);
          curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt ($ch, CURLOPT_POSTFIELDS, array('photo' => '@' . dirname(__FILE__) .'/x_55a8c888.jpg'));
          curl_setopt ($ch, CURLOPT_USERAGENT, VKXP_DEFAULT_BROWSER);
          $result = curl_exec($ch);
          curl_close($ch);
          $load_result = json_decode($result, true);
          
          //savePhoto
          $params = array();
          $params['access_token'] = $access_token;
          $params['server'] = $load_result['server'];
          $params['photo'] = $load_result['photo'];
          $params['hash'] = $load_result['hash'];
          $params['gid'] = $group_id;
          $result = _vkxp_curl_post('photos.saveWallPhoto', $params);
          $result = json_decode($result, true);
          $id = $result['response'][0]['id'];

          //post message
          $params = array();
          //$params['owner_id'] = "-$group_id";
          $params['owner_id'] = 3546809;
          $params['message'] = $body;
          $params['from_group'] = variable_get('vkxp_official', 1);
          $params['attachments'] = $id .','. $url;
          $params['access_token'] = $access_token;
          $result = _vkxp_curl_post('wall.post', $params);
          $result = json_decode($result, true);

          if ($result['response']['post_id']) {
            drupal_set_message(t('Data was successfully posted to vkontakte.ru'));
          }
          elseif ($result['response']['processing']) {
            drupal_set_message(t('Data for vkontakte.ru was accepted, but will be posted a little bit later'));
          }
          else {
            drupal_set_message(t('Data was not posted to vkontakte.ru.'), 'warning');
          }
        }
      }
      break;
  }
}

function _vkxp_curl_post($method, $data, $url = 'https://api.vkontakte.ru/method/') {
  $ch = curl_init();
  curl_setopt ($ch, CURLOPT_URL, $url . $method);
  curl_setopt ($ch, CURLOPT_POST, 1);
  curl_setopt ($ch, CURLOPT_POSTFIELDS, $data);
  curl_setopt ($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
  curl_setopt ($ch, CURLOPT_RETURNTRANSFER, 1);
  $result = curl_exec($ch);
  curl_close($ch);
  return $result;
}